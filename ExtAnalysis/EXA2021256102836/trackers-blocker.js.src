var _extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var s=arguments[e];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(t[r]=s[r])}return t};class TrackerBlocker{constructor(t){this.extensionId=webextApi.runtime.getURL("").split("://")[1].slice(0,-1),this.store=t;const e=t.getState();this._trackersList=void 0,this._allowList=e.trackerBlockerData.allowList,this._blockAll=e.trackerBlockerData.allBlocked,this.listener=async t=>{if(t&&t.url)try{const e=getCleanDomain(t.url),s=this.trackersList[e];if(!s)return{cancel:!1};const r=t.tabId,i=t.originUrl;let l=t.initiator;return r>-1&&(l=await this.getInitiatorByTabId(r)),l||i?(l=getCleanDomain(l||i),l.includes(this.extensionId)?{cancel:!1}:(this.store.dispatch(trackerDetected(_extends({},s,{initiator:l}))),{cancel:!this.allowList[s.name]})):{cancel:!1}}catch(t){return{}}},this.startListener()}getInitiatorByTabId(t){const e=this.store.getState().tabs[t];return e&&e.url?Promise.resolve(e.url):new Promise(e=>{webextApi.tabs.get(t,t=>{if(t&&t.url)return e(t.url);e("")})})}get allowList(){return this._allowList||(this._allowList=_extends({},this.store.getState().trackerBlockerData.allowList)),this._allowList}flush(){this._trackersList=void 0,this._blockAll=void 0,this.flushAllowList(),this.startListener()}flushAllowList(){this._allowList=void 0}get blockAll(){return void 0===this._blockAll&&(this._blockAll=_extends({},this.store.getState().trackerBlockerData.allBlocked)),this._blockAll}get trackersList(){return this._trackersList||(this._trackersList=this.store.getState().trackerBlockerData.list),this._trackersList}startListener(){this.clearListener(),webextApi.webRequest.onBeforeRequest.addListener(this.listener,{urls:["*://*/*"]},["blocking"])}clearListener(){webextApi.webRequest.onBeforeRequest.removeListener(this.listener)}}