var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var s in a)Object.prototype.hasOwnProperty.call(a,s)&&(e[s]=a[s])}return e};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}function filterLinksBeforeSend(e,t){return Array.from(e.reduce((e,a)=>{const s=getCleanDomain(a);return t[s]||e.add(s),e},new Set))}function parseUserReview(e,t,a){return{comment:e.comment,safety:e.rating,tags:e.tags,id:e.id,uid:t,target:a}}const aliases={[SEND_USER_REVIEW_TO_SERVER]:e=>(t,a)=>{setTimeout(()=>{const s=e.data.unauthReviews,r=_.get(a(),"user.uid",null),o=_.get(s,"rating",-1);if(null!==s&&-1!==o&&s.step>=4){const a=[].concat(_toConsumableArray(_.get(s,"childSafetyCategories",[])),_toConsumableArray(_.get(s,"reputationCategories",[])),_toConsumableArray(_.get(s,"safetyCategories",[]))),n=Date.now()/1e3;t(saveCommentAndReview(e.data.host,_.get(s,"comment",""),n,a,o,r))}},1500)},[LOGIN_ACTION]:e=>t=>{WotAuthApi.login(e.data.username,e.data.password).then(e=>{t({type:SAVE_USER_TOKEN,data:{token:e}})},e=>{GA("Login","Error",e.code),t({type:ERROR_USER_AUTH,data:{code:e.code,message:e.message}})})},[SAVE_USER_TOKEN]:e=>{try{webextApi.tabs.query({},(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];for(const t of e)t.url.match(SOCIAL_CALLBACK_URL)&&webextApi.tabs.remove(t.id)}))}catch(e){}return(t,a)=>{WotAuthApi.getUser(e.data&&e.data.token||a().user.token).then(s=>{webextApi.tabs.query({active:!0,lastFocusedWindow:!0},r=>{if(!r)return;const o=_.get(r[0],"url",null)||_.filter(a().tabs,{active:!0})[0].url,n=getEncodedDomain(o),i=JSON.parse(JSON.stringify(_.get(a(),`reviews.1['${n}']`,null)));t({type:SEND_USER_REVIEW_TO_SERVER,data:{host:n,unauthReviews:i}}),t({type:SAVE_USER_DATA,data:_.merge(s,{token:e.data.token}),host:n}),t({type:GET_USER_PLAN})})},e=>{GA("User","Error",e.code),t({type:ERROR_USER_AUTH,data:{code:e.code,message:e.message}})})}},[REGISTER_ACTION]:e=>t=>{var a=e.data;const s=a.name,r=a.mail,o=a.pass,n=a.Pass2;WotAuthApi.register(s,r,o,n).then(e=>{t({type:SAVE_USER_TOKEN,data:{token:e}}),WotAuthApi.getUser(e).then(e=>{t({type:SAVE_USER_DATA,data:e})},e=>{GA("User","Error",e.code+" after register"),t({type:ERROR_USER_AUTH,data:{code:e.code,message:e.message}})})},e=>{GA("Register","Error",e.code),t({type:ERROR_USER_AUTH,data:{code:e.code,message:e.message}})})},[LOGOUT_ACTION]:()=>(e,t)=>{const a=t().user.token;WotAuthApi.logout(a).then(()=>{}).catch(()=>{}).finally(()=>{e({type:CLEAR_USER_REVIEWS,data:{userId:t().user.uid}}),e({type:CLEAN_USER_DATA}),e(toggleBlockAllTrackers(!1))})},[FORGOT_ACTION]:e=>t=>{WotAuthApi.forgot(e.email).then(e=>{t({type:MESSAGE_USER_AUTH,data:{message:e}})},e=>{GA("Forgot","Error",e.code),t({type:ERROR_USER_AUTH,data:{code:e.code,message:e.message}})})},[GET_USER_PLAN]:()=>(e,t)=>{var a=t().user;const s=a.uid,r=a.token;WotApi.getIsPremium(s,r).then(a=>{"safari"===browserName&&(a={isPremium:!0}),e({type:SAVE_USER_PLAN,data:{isPremiumUser:!!a&&a.isPremium}}),setTimeout(()=>{var a=t();const s=a.user,r=a.settings;s.isPremiumUser&&!1!==r.assistant&&e({type:ASSISTANT_ON})})},t=>{if("safari"===browserName)return e({type:SAVE_USER_PLAN,data:{isPremiumUser:!0}}),void 0;e({type:CLEAN_USER_DATA})})},[SEND_QUERY_ACTION]:e=>(t,a)=>{var s=e.data;const r=s.targetParams,o=s.headers,n=r.subtrgt;var i=a();const d=i.ratings,c=i.settings;SUPPORTED_PROTOCOLS.test(n)&&!checkLocalhost(n)&&c.protection&&(r.links=filterLinksBeforeSend(r.links,d),t({type:SERP_MARK_LINKS_PENDING,data:{urls:r.links}}),WotApi.query(r,o).then(e=>{t(saveRating(e))},e=>{GA("QUERY","Error",e.message())}))},[SERP_SEND_LINKS_ACTION]:e=>(t,a)=>{setTimeout(()=>{var s=a();const r=s.settings,o=s.ratings;if(!r.protection)return;const n=filterLinksBeforeSend(e.data.urls,o);n.length&&(t({type:SERP_MARK_LINKS_PENDING,data:{urls:n}}),WotApi.query({links:n}).then(e=>{t(saveRating(e))},e=>{GA("Query","Error",e.message())}))},200)},[ADD_COMMENT_ACTION]:()=>(e,t)=>{const a=t().focusedReview;WotApi.sendComments({target:a.target,comment:a.comment,safety:a.safety,categories:a.tags},t().user.token).then(()=>{e(getCommentAndRating(a.target)),webextApi.runtime.sendMessage({action:SHOW_TOAST_NOTIFICATION,notification:"reviewAddedOK"})}).catch(()=>{webextApi.runtime.sendMessage({action:SHOW_TOAST_NOTIFICATION,notification:"reviewAddedError"})})},[DELETE_REVIEW_ACTION]:e=>(t,a)=>{var s=e.data;const r=s.uid,o=s.target;t(deleteReview(o,r)),a().user.uid&&WotApi.deleteComments(o,a().user.token)},[GET_COMMENTS_ACTION]:e=>(t,a)=>{var s=e.data;const r=s.host,o=s.length,n=s.uid;let i=e.data.offset;t(loadingComments(r));const d=a();void 0===i&&(i=d.comments[r]&&d.comments[r].data&&Object.keys(d.comments[r].data).length||0),WotApi.comments(r,n,o,i).then(e=>{t(saveComments(_.merge(e[0],e[1])))},e=>{GA("comments","error",e.message||e)})},[GET_COMMENT_AND_RATING]:e=>(t,a)=>{const s=e.data.host;var r=a().user;const o=r.uid,n=r.token;o&&1!==o&&WotApi.getUserReview(s,n).then(e=>{t(updateReviewTimestamp(s,o));const a=CATEGORIES_RULES.ratingFlow,r=e.categories||[],n=e.rating&&20*e.rating.stars||-1;if(-1===n)return t(deleteReview(s,o)),t(updateReviewTimestamp(s,o)),void 0;const i=r.filter(e=>1===e.vote&&a.childSafety.includes(e.name)),d={host:s,comment:e.comment,rating:n,step:6,timestamp:e.timestamp/1e3,childSafetyCategories:i,reputationCategories:r.filter(e=>1===e.vote&&a.reputation.includes(e.name)),safetyCategories:r.filter(e=>1===e.vote&&a.safety.includes(e.name)),childSafety:0===i.length,tags:r.map(e=>e.name),uid:o,id:e.id};t(saveUserReviewFromApi(d))}).catch(e=>{console.log(`GET USER COMMENT FOR ${s} REQUEST FAILED WITH`,e)})},[LOAD_TRACKERS_LIST]:()=>e=>{WotApi.getTrackersUrls().then(t=>{e(loadTrackersListCompleted(t))},()=>{setTimeout(()=>{e(loadTrackersList())},6e4)})},[OPEN_ADD_REVIEW_ACTION]:e=>(t,a)=>{var s=e.data;const r=s.uid,o=s.domain;var n=a();const i=n.focusedReview,d=n.reviews;return i&&i.safety>-1&&i.target===o?(t(setReviewInFocus(_extends({},i,{safety:e.data.stars?20*e.data.stars:i.safety}))),void 0):d[r]&&d[r][o]&&d[r][o].rating>-1?(t(setReviewInFocus(parseUserReview(d[r][o],r,o))),void 0):(t(setReviewInFocus(_extends({},BlankReview,{safety:20*e.data.stars,target:o,uid:r}))),void 0)},[UPDATE_REVIEW]:e=>(t,a)=>{var s=e.data;const r=s.uid,o=s.domain;const n=a().reviews;n[r]&&n[r][o]&&t(setReviewInFocus(parseUserReview(n[r][o],r,o)))}};