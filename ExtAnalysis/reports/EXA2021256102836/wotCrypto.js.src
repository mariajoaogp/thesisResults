function strtobin(t){const n=[];for(let e=0;e<t.length;++e)n[e]=255&t.charCodeAt(e);return n}function bintostr(t){let n="";for(let e=0;e<t.length;++e)n+=String.fromCharCode(255&t[e]);return n}function hextobin(t){const n=function(t){const n="a".charCodeAt(0);return t>=n?t-n+10:t-"0".charCodeAt(0)},e=[];for(let r=0;r<t.length/2;++r)e[r]=n(t.charCodeAt(2*r))<<4|15&n(t.charCodeAt(2*r+1));return e}function bintohex(t){const n="0123456789abcdef";let e="";for(let r=0;r<t.length;++r)e+=n.charAt(t[r]>>4&15),e+=n.charAt(15&t[r]);return e}const sha1={hmacsha1hex(t,n){let e=hextobin(t);e.length>20&&(e=this.sha1bin(e));const r=Array(64),o=Array(64);for(let t=0;t<20;++t)r[t]=54^e[t],o[t]=92^e[t];for(let t=20;t<64;++t)r[t]=54,o[t]=92;const s=this.sha1bin(r.concat(strtobin(n)));return this.sha1bin(o.concat(s))},sha1bin(t){return this.sha1str(bintostr(t))},sha1hex(t){return this.sha1str(hextostr(t))},sha1str(t){const n=function(t,n,e,r){return t<20?n&e|~n&r:t>=40&&t<60?n&e|n&r|e&r:n^e^r},e=function(t){return t<20?1518500249:t<40?1859775393:t<60?-1894007588:-899497514},r=function(t,n){const e=(65535&t)+(65535&n);return(t>>16)+(n>>16)+(e>>16)<<16|65535&e},o=function(t,n){return t<<n|t>>>32-n},s=8*t.length;let c=[];for(var h=0;h<s;h+=8)c[h>>5]|=(255&t.charCodeAt(h/8))<<24-h%32;c[s>>5]|=128<<24-s%32,c[15+(s+64>>9<<4)]=s;const i=Array(80);let a=1732584193,l=-271733879,u=-1732584194,f=271733878,d=-1009589776;for(h=0;h<c.length;h+=16){const t=a,s=l,y=u,b=f,g=d;for(let t=0;t<80;t++){i[t]=t<16?c[h+t]:o(i[t-3]^i[t-8]^i[t-14]^i[t-16],1);const s=r(r(o(a,5),n(t,l,u,f)),r(r(d,i[t]),e(t)));d=f,f=u,u=o(l,30),l=a,a=s}a=r(a,t),l=r(l,s),u=r(u,y),f=r(f,b),d=r(d,g)}c=[a,l,u,f,d],t="";for(h=0;h<32*c.length;h+=8)t+=String.fromCharCode(c[h>>5]>>>24-h%32&255);return strtobin(t)}},arc4={create(t){let n,e,r=0,o=0;const s={s:[],x:1,y:0};for(n=0;n<256;++n)s.s[n]=n;for(n=0;n<256;++n)e=s.s[n],r=r+t[o]+e&255,s.s[n]=s.s[r],s.s[r]=e,++o>=t.length&&(o=0);return s},crypt(t,n){let e,r,o;const s=[];for(e=0;e<n.length;++e)r=t.s[t.x],t.y=t.y+r&255,o=t.s[t.y],t.s[t.x]=o,t.s[t.y]=r,t.x=t.x+1&255,s[e]=255&(n[e]^t.s[r+o&255]);return s}},base32={set:"abcdefghijklmnopqrstuvwxyz234567",encode(t){try{t=unescape(encodeURIComponent(decodeURIComponent(t)));let n="",e=0,r=0;for(let o=0;o<t.length;++o){const s=t.charCodeAt(o);if(s>255)return null;e=(e<<8)+s,r+=8;do{r-=5,n+=this.set[e>>r&31]}while(r>=5)}return r>0&&(n+=this.set[e<<5-r&31]),n}catch(t){console.log(`base32.encode: failed with ${t}\n`)}return null},decode(t){try{if(!this.rev){this.rev={};for(var n=0;n<this.set.length;++n)this.rev[this.set.charAt(n)]=n}let e="",r=0,o=0;for(n=0;n<t.length;++n){const s=this.rev[t.charAt(n)];if(null==s)return null;for(r=(r<<5)+s,o+=5;o>=8;)o-=8,e+=String.fromCharCode(r>>o&255)}return o>=5?null:decodeURIComponent(escape(e))}catch(t){console.log(`base32.decode: failed with ${t}\n`)}return null}};class WotCryptoClass{constructor(t){this.counter=t||0,this.sha1=sha1,this.arc4=arc4,this.bintohex=bintohex,this.base32=base32}getnonce(t,n){const e=`nonce:${VERSION}:${window.navigator.language}:${this.counter++}:${Date.now()}:${Math.random()}:${(n||{id:"",key:""}).id||""}:${t||""}`;return bintohex(this.sha1.sha1str(e))}decrypt(t,n,e){try{if(t&&n){const r=e&&e.witness_key?e.witness_key:this.witness.key;let o=(e||{}).index;const s=(e||{}).response_str;o=null==o||o<0?"":"-"+o;let c=n+o;if(s&&(c="response-"+c),r)return bintostr(this.arc4.crypt(this.arc4.create(this.sha1.hmacsha1hex(r,c)),strtobin(atob(t))))}}catch(t){console.log(`crypto.decrypt: failed with ${t}\n`)}return null}encrypt(t,n,e,r){try{if(t&&n){if(!e)e=(r||{}).key;if(e)return btoa(bintostr(this.arc4.crypt(this.arc4.create(this.sha1.hmacsha1hex(e,n)),strtobin(t))))}}catch(t){console.log(`crypto.encrypt: failed with ${t}\n`)}return null}authenticate(t,n){try{const e=(n||this.witness||{}).key;if(e)return bintohex(this.sha1.hmacsha1hex(e,t))}catch(t){console.log(`crypto.authenticate: failed with ${t}\n`)}return null}sha1str(t){const n=function(t,n,e,r){return t<20?n&e|~n&r:t>=40&&t<60?n&e|n&r|e&r:n^e^r},e=function(t){return t<20?1518500249:t<40?1859775393:t<60?-1894007588:-899497514},r=function(t,n){const e=(65535&t)+(65535&n);return(t>>16)+(n>>16)+(e>>16)<<16|65535&e},o=function(t,n){return t<<n|t>>>32-n},s=8*t.length;let c=[];for(var h=0;h<s;h+=8)c[h>>5]|=(255&t.charCodeAt(h/8))<<24-h%32;c[s>>5]|=128<<24-s%32,c[15+(s+64>>9<<4)]=s;const i=Array(80);let a=1732584193,l=-271733879,u=-1732584194,f=271733878,d=-1009589776;for(h=0;h<c.length;h+=16){const t=a,s=l,y=u,b=f,g=d;for(let t=0;t<80;t++){i[t]=t<16?c[h+t]:o(i[t-3]^i[t-8]^i[t-14]^i[t-16],1);const s=r(r(o(a,5),n(t,l,u,f)),r(r(d,i[t]),e(t)));d=f,f=u,u=o(l,30),l=a,a=s}a=r(a,t),l=r(l,s),u=r(u,y),f=r(f,b),d=r(d,g)}c=[a,l,u,f,d],t="";for(h=0;h<32*c.length;h+=8)t+=String.fromCharCode(c[h>>5]>>>24-h%32&255);return strtobin(t)}}const WotCrypto=new WotCryptoClass;