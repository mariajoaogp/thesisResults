var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,i=!1,s=void 0;try{for(var o,a=e[Symbol.iterator]();!(n=(o=a.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw s}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _objectWithoutProperties(e,t){var r={};for(var n in e)t.indexOf(n)>=0||Object.prototype.hasOwnProperty.call(e,n)&&(r[n]=e[n]);return r}class SerpHandler{constructor(e){this.store=e,this.hrefsForRequest=new Set}init(){var e=this.store.getState();const t=e.serps,r=e.settings,n=window.location.href;if(this.serp=t.find(e=>new RegExp(e.pattern).test(n)),this.serp){if(!r.protection)return this.store.dispatch(OptOutPopUp("search")),webextApi.runtime.sendMessage({name:ICON_NOTIFICATION}),webextApi.runtime.onMessage.addListener(e=>{e.action===PING&&this.store.getState().settings.protection&&this.init(),e.action===HISTORY_UPDATED&&this.store.getState().settings.protection&&setTimeout(this.renderMail.bind(this),500)}),void 0;if(document.querySelector("."+POPUP_CONTAINER)||(this.popupContainer=document.createElement("div"),this.popupContainer.className=POPUP_CONTAINER,document.body.insertBefore(this.popupContainer,document.body.firstChild)),document.querySelector("."+POPUP_OVERLAY)||(this.popupOvelay=document.createElement("div"),this.popupOvelay.className=POPUP_OVERLAY,document.body.insertBefore(this.popupOvelay,document.body.firstChild)),this.hostname=getCleanDomain(window.location.href),this.styles=this.serp.styles,this.ignoreUrl=this.serp.ignoreUrl,this.ignoreParent=this.serp.ignoreParent,this.ignoreChild=this.serp.ignoreChild,this.rules=this.serp.rules,this.areasAttributes=this.serp.areasAttributes,this.serpid=this.serp.id,this.showOnBoarding=this.serp.showOnBoarding,this.alreadyRendered=!1,this.rules||this.areasAttributes){window.addEventListener("load",()=>{setTimeout(this.render.bind(this),300)});const e=()=>{this.popupContainer&&(this.popupContainer.innerHTML="")};let t=window.scrollY;window.addEventListener("scroll",r=>{Math.abs(t-window.scrollY)>700&&(t=window.scrollY,e(r),this.render())}),window.addEventListener("popstate",e),window.addEventListener("hashchange",e),window.addEventListener("resize",e),this.render()}window.addEventListener("click",e=>{e.target.classList.contains("wot_shield")&&(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation())},!0)}}isMutationRelatedToWOT(e){const t=e.target,r=e.attributeName,n=e.addedNodes,i=(n[0]&&n[0].className||"")+(t?t.className:("",""));return WOTAttributes.includes(r)||WOTClassesRegExp.test(i)}observeElem(e){if(e&&!e.getAttribute(WOT_OBSERVE_DOM_FLAG)){e.setAttribute(WOT_OBSERVE_DOM_FLAG,"true");const t={attributes:!0,childList:!0,subtree:!0};new MutationObserver(t=>{if(!t.some(e=>this.isMutationRelatedToWOT(e)))return Array.from(e.getElementsByTagName("a")).forEach(e=>{e.removeAttribute(TAG_SCANNED_FLAG),e.removeAttribute(SHIELD_ATTRIBUTE)}),setTimeout(this.render.bind(this))}).observe(e,t)}}preventCreatingTwice(e,t){let r;switch(t){case"insertAfter":r=e.nextElementSibling;break;case"appendChild":r=e.lastElementChild;break;default:webextApi.runtime.sendMessage({name:CONSOLE_LOG_MESSAGE,message:"unknown action. check rule configuration: "+t})}return r&&r.className===SHIELD_CONTAINER}async renderMail(){this.addEventOnce=this.addEventOnce||!1,this.addEventOnce||(this.addEventOnce=!0,window.addEventListener("popstate",()=>{setTimeout(this.renderMail.bind(this),500)}));const e=document.querySelector(this.serp.areasAttributes.mail_body.selector),t=()=>{if(!this.serp.sender)return;var t=this.serp.sender;const r=t.selector,n=t.attribute;if(!r)return;const i=e.querySelector(r);if(!i)return;const s=n?i.getAttribute(n):i.innerText;if(!s)return;const o=s.split("@");if(!o[1])return;const a=o[1];return">"===a[a.length-1]?a.slice(0,-1):a};let r=[this.hostname];if(e){const n=new Set;Array.from(e.getElementsByTagName("a")).forEach(e=>{n.add(getCleanDomain(e.href))});const i=t();i&&n.add(i),n.size&&(r=r.concat(Array.from(n)),this.store.dispatch(getMultipleRatings(r)))}var n=(()=>{var t=this.store.getState();const r=t.user,n=t.settings;let i="";const s=r.isPremiumUser&&n.phishing;if(i=e?s?MAIL_BODY_SERP_CONTAINER:null:r.isPremiumUser?null:MAIL_BODY_SERP_NOT_PROTECTED,!i)return{container:null};let o=document.getElementById(i);if(!o){o=(s?document.querySelector(this.serp.areasAttributes.mail_body.place):document.body)[this.serp.areasAttributes.mail_body.action](document.createElement("div")),o.id=i}return{container:o,protectionEnabled:s}})();const i=n.container,s=n.protectionEnabled;i&&ReactDOM.render(React.createElement(ReactRedux.Provider,{store:this.store},s?React.createElement(SerpWarning,{links:r}):React.createElement(SerpOffering,null)),i)}renderSocial(){const e={};Array.from(document.getElementsByTagName("a")).forEach(t=>{if(!t.host||t.host===window.location.host)return;if(t.getAttribute(TAG_SCANNED_FLAG))return;const r=new URL(decodeURIComponent(t.href)),n=!r.host.includes(this.serp.domain),i=!n&&!!r.search;if(!i&&!n)return;const s=this.getSignificantWrapper(t);if(!s)return;const o=s.element.getAttribute(SERP_AREA_FLAG)||makeid();e[o]||(e[o]={parent:s},s.element.setAttribute(SERP_AREA_FLAG,o)),t.setAttribute(TAG_SCANNED_FLAG,"true");const a=new URL(i?new URL(r.search.split("=")[1]).href:r.href);e[o][a.hostname]=e[o][a.hostname]||[],e[o][a.hostname].push({target:a.href,a:t}),this.hrefsForRequest.add(a.href),s.type===SERP_AREA_TYPES.SPONSORED&&this.observeElem(s.element)}),this.hrefsForRequest.add(this.hostname),this.store.dispatch(getMultipleRatings(Array.from(this.hrefsForRequest))),Object.values(e).forEach(e=>{const t=e.parent,r=_objectWithoutProperties(e,["parent"]),n=t.type===SERP_AREA_TYPES.NEWS_FEED,i=Object.values(r);i.forEach(e=>{const r=this.selectBestPosition(e);let s=r.el;var o=this.serp.areasAttributes[t.type];const a=o.place;var l=o.style;const c=void 0===l?{position:"absolute",top:"0",left:"0"}:l;if(n&&1===i.length&&(s=t.element),s=a?s.querySelector(a):s,!s||s.getAttribute(SHIELD_ATTRIBUTE))return;s.setAttribute(SHIELD_ATTRIBUTE,"true"),s.style.position="relative";const u=this.makeContainer();Object.entries(c).forEach(e=>{var t=_slicedToArray(e,2);let r=t[0],n=t[1];u.style[r]=n}),s.appendChild(u),setTimeout(()=>{ReactDOM.render(React.createElement(ReactRedux.Provider,{store:this.store},React.createElement(ShieldComponent,{store:this.store,target:r.target,serpid:this.serpid,containerSelector:"#"+u.id,style:{},additionalContainerStyle:{},isOnboarding:this.showOnBoarding,showAdultExtraIcon:!0,inactive:!1})),u)})})})}render(){if("Facebook"===this.serp.name)return this.renderSocial();if("mail"===this.serp.type)return setTimeout(()=>this.renderMail(),500);for(let e=0,t=this.rules.length;e<t;e++){const t=this.rules[e],r=Array.from(document.querySelectorAll(t.areaSelector)),n=[this.hostname];for(const e of r)if(!e.getAttribute(SHIELD_ATTRIBUTE)){let r=!1;if(this.ignoreParent)for(const t of this.ignoreParent){let n=e.parentNode;const i=document.querySelectorAll(t);for(;n;)-1!==Array.from(i).indexOf(n)&&(r=!0),n=n.parentNode}const i=t.linkSelector?e.querySelector(t.linkSelector):e;if(this.ignoreChild)for(const e of this.ignoreChild)i.querySelectorAll(e).length>0&&(r=!0);if(i&&!r){let r,s=i.href||"";if(r=t.placeSelector?Array.from(e.querySelectorAll(t.placeSelector)):[e],t.getParam){const e=s.match(`[?&]${t.getParam}=([^&]+)`);s=decodeURIComponent(e&&e.length>=2?e[1]:s)}if(t.fromString){const e=new RegExp(t.fromString).exec(i.textContent);s=e?e[0]:s}t.beforeUrl&&(s=t.beforeUrl+s);for(const i of r)if(s&&(SUPPORTED_PROTOCOLS.test(s)||0===s.indexOf("www."))&&0!==s.indexOf(window.location.href)){if(this.ignoreUrl&&new RegExp(this.ignoreUrl).test(s))continue;if(this.preventCreatingTwice(i,t.action))continue;const r=this.makeContainer(t);if(r.setAttribute("style",t.styles||this.styles),0!==i.textContent.trim().length||t.images)switch(t.action){case"appendChild":i.appendChild(r);break;case"insertAfter":i.parentNode.insertBefore(r,i.nextSibling)}else i.style.position="relative",i.style.display="inline-block",r.style.position="absolute",r.style.top="0",r.style.right="0",r.style.margin="0",i.appendChild(r);n.push(s);const o="false"!==t.adultIcon,a=this.getIsOnboarding(),l=this.ensureIsObject(t.shieldStyle),c=this.ensureIsObject(t.additionalContainerStyle);setTimeout(()=>{ReactDOM.render(React.createElement(ReactRedux.Provider,{store:this.store},React.createElement(ShieldComponent,{store:this.store,target:s,serpid:this.serpid,containerSelector:"#"+r.id,style:l,additionalContainerStyle:c,isOnboarding:a,showAdultExtraIcon:o,inactive:a&&this.alreadyRendered})),document.querySelector("#"+r.id))},1),this.alreadyRendered=!0,t.urlCanChange&&e.setAttribute(SHIELD_ATTRIBUTE,"true")}!t.urlCanChange&&e.setAttribute(SHIELD_ATTRIBUTE,"true")}}this.store.dispatch(getMultipleRatings(n))}}makeContainer(e){const t=document.createElement("div");return t.id=makeid(),t.className=SHIELD_CONTAINER,t.setAttribute("style",e&&e.styles||this.styles),t}getIsOnboarding(){return this.showOnBoarding&&this.store.getState().onboarding.step<5&&"rtl"!==document.dir}ensureIsObject(e){return"object"==typeof e?e:{}}selectBestPosition(e){e.sort((e,t)=>t.a.innerHTML.length-e.a.innerHTML.length);const t=e[0];return{el:t.a,target:t.target}}getSignificantWrapper(e){let t=e.parentElement,r=this.areasAttributes[SERP_AREA_TYPES.NEWS_FEED];do{if(t.getAttribute(r.key)===r.value)break}while(t=t.parentElement);if(t)return{element:t,type:SERP_AREA_TYPES.NEWS_FEED};t=e.parentElement,r=this.areasAttributes[SERP_AREA_TYPES.SPONSORED];do{if(t.getAttribute(r.key)===r.value)break}while(t=t.parentElement);return t?{element:t,type:SERP_AREA_TYPES.SPONSORED}:null}}self.yodules=self.yodules||{},void(yodules.ScrapByRemoteConfigCt={init:function(e){const t=yodules.ScrapByRemoteConfigCt,r=e.class;t.class=class{main(){if(this.searchCache={},"complete"===document.readyState)this.onDocReady();else{let e;const t=()=>{clearInterval(e),this.onDocReady()};document.addEventListener("DOMContentLoaded",t),e=setTimeout(()=>{document.removeEventListener("DOMContentLoaded",t),this.onDocReady()},2e3)}}async onDocReady(){try{const e=(await Promise.all([this.getConfigFromChromeStorage(),this.waitForDomChanges()]))[0];e&&e.length&&this.execConfigs(e)}catch(e){}}execConfigs(e){const t=new r,n=t.vmajor,i=t.vminor,s=location.href,o=e.filter(e=>e.vmajor===n&&(!(e.vminor>i)&&!!new RegExp(e.matcher).exec(s))).map(e=>this.execOneTriggeredConfig(e)).filter(e=>!!e);this.notifyBackground(o)}notifyBackground(e){e&&e.length&&JSON.stringify(e).length>8&&chrome.runtime.sendMessage({message:"m('scrap_collected')",scraps:e})}_onTrigger(e,t){if(!e||!e.name)return t();switch(e.name){case"domTrigger":this._onDomTrigger(e,t);break;case"domManyTrigger":this._onDomManyTrigger(e,t);break;case"mutationTrigger":this._onMutationObserver(e,t);break;case"timeTrigger":this._onTimeTrigger(e,t);break;default:t()}}_onDomTrigger(e,t){let r=document.body;if(e.element&&(r=document.querySelector(e.element),!r))return;const n=i=>{e.delayDefault&&(i.preventDefault(),i.stopImmediatePropagation()),t(),e.delayDefault&&(r.removeEventListener(e.eventName,n),setTimeout(()=>{r.dispatchEvent(i)},e.delayDefaultForMs||100))};r.addEventListener(e.eventName,n)}_onDomManyTrigger(e,t){let r=[document];(!e.elements||(r=Array.from(document.querySelectorAll(e.elements)),r&&r.length))&&r.forEach(r=>{const n=i=>{e.delayDefault&&(i.preventDefault(),i.stopImmediatePropagation()),t(),e.delayDefault&&(r.removeEventListener(e.eventName,n),setTimeout(()=>{r.dispatchEvent(i)},e.delayDefaultForMs||100))};r.addEventListener(e.eventName,n)})}_onMutationObserver(e,t){let r=document.body;if(e.element&&(r=document.querySelector(e.element),!r))return;const n=e.cooldown||1e3;let i;new MutationObserver((function(){clearTimeout(i),i=setTimeout(t,n)})).observe(r,{attributes:!0,childList:!0,characterData:!0})}_onTimeTrigger(e,t){const r=e.timeout||5e3;e.times?async function(){for(let n=0;n<e.times;n++)await new Promise(e=>{setTimeout(e,r)}),t()}():setTimeout(t,r)}execOneTriggeredConfig(e){return e.triggers instanceof Array?(e.triggers.forEach(t=>{this._onTrigger(t,()=>{const t=this.execOneConfig(e);if(t){if(t.data instanceof Array&&!t.data.length)return;this.notifyBackground([t])}})}),null):this.execOneConfig(e)}execCompoundConfig(e){const t={};return e.clauses.forEach(e=>{t[e.name]=this.execSimpleConfig(e)}),t}execSimpleConfig(e){const t=new r;t.setConfig(e.find);let n=t.execute();if(void 0===n)return[];if(!(n instanceof Array)){if(!(n instanceof Node))return[];n=[n]}if(e.uniqueCheck){const t=e.uniqueCacheKey||e.find.type+JSON.stringify(e.find).length,r=this.searchCache[t];if(r instanceof Set){const e=n.filter(e=>!r.has(e));e.forEach(e=>r.add(e)),n=e}else this.searchCache[t]=new Set(n)}const i=n.map(t=>{const n=new r;return n.setConfig(e.analyse),n.execute(t)}).filter(e=>!!e);return e.hasOwnProperty("type")?{type:e.type,data:i}:i}execOneConfig(e){try{switch(e.configType){case"compound":return this.execCompoundConfig(e);case"simple":default:return this.execSimpleConfig(e)}}catch(e){return null}}waitForDomChanges(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:500;return new Promise(t=>{let r;const n=new MutationObserver((function(){clearTimeout(r),void(r=setTimeout(()=>{t()},e))}));n.observe(document.body,{attributes:!0,childList:!0,characterData:!0}),setTimeout(()=>{n.disconnect(),t()},3e3)})}getConfigFromChromeStorage(){return new Promise(e=>{chrome.storage.local.get("m('remote_config_storage_key')",t=>{if(!t)return e(null);const r=t["m('remote_config_storage_key')"];if(r)try{e(r.map(e=>this.deobfuscateConfig(e)))}catch(t){return e(null)}e(null)})})}deobfuscateConfig(e){if(e.hasOwnProperty("type"))return e;const t=e.e.split("\n"),r=t[0].length;let n="";for(let e=0;e<r;e++)for(let r=0;r<t.length;r++){const i=t[r].charAt(e);if(!i)break;n+=i}const i=atob(n);return JSON.parse(i)}},t.instance=new t.class,t.instance.main()},deps:["RemoteScrapConfigInterpreter"]}),self.yodules=self.yodules||{},yodules.RemoteScrapConfigInterpreter={init:function(){yodules.RemoteScrapConfigInterpreter.class=class{get vmajor(){return 1}get vminor(){return 6}get config(){return this._config}setConfig(e){return this._config=e,this}execute(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document.documentElement;return this._executeConfig(e)}_executeConfig(e){return this._ruleToValue(this.config,e)}_ruleToValue(e,t){switch(e.type){case"filter":return this._toValueFilter(e,t);case"map":return this._toValueMap(e,t);case"selector":return this._toValueSelector(e,t);case"statement":return this._toValueStatement(e,t);case"check":return this._toValueCheck(e,t);case"action":return this._toValueAction(e,t);case"aggregate":return this._toValueAggregate(e,t);case"condition":return this._toValueCondition(e,t);case"constant":return e.value;case"try":return this._toValueTry(e,t)}}_toValueFilter(e,t){return this._ruleToValue(e.items,t).filter(t=>this._ruleToValue(e.condition,t))}_toValueMap(e,t){let r=this._ruleToValue(e.items,t).map(t=>this._ruleToValue(e.action,t));return e.no_empty&&(r=r.filter(e=>!!e)),r}_toValueSelector(e,t){if(e.target&&(t=this._ruleToValue(e.target,t)),"first"===e.qualifier)return t.querySelector(e.selector);{const r=t.querySelectorAll(e.selector);return r?Array.prototype.slice.call(r):[]}}_toValueStatement(e,t){const r="or"===e.conjuction,n=!r;for(let i,s,o=0;o<e.subStatements.length;o++){if(i=e.subStatements[o],s=this._ruleToValue(i,t),s&&r)return!0;if(!s&&n)return!1}return n}_toValueCondition(e,t){const r=e.condition,n=e.caseTrue,i=e.caseFalse;return this._ruleToValue(r,t)?this._ruleToValue(n,t):this._ruleToValue(i,t)}_toValueCheck(e,t){const r="not"===e.modifier;let n;switch(e.if){case"exists":n=e=>!(!e||e instanceof Array&&!e.length);break;case"regexp":n=t=>!!new RegExp(e.regexp).exec(t)}let i=n;return r&&(i=e=>!n(e)),i(this._ruleToValue(e.object,t))}_toValueAction(e,t){let r;switch(e.action){case"take-text":r=e=>e.innerText;break;case"take-attr":r=t=>t.getAttribute(e.attrName);break;case"take-prop":r=t=>t[e.propName];break;case"take-parent":r=e=>e.parentNode;break;case"take-ancestor":r=t=>t.closest(e.selector);break;case"exec-regexp":r=t=>new RegExp(e.regexp).exec(t);break;case"string-split":r=t=>(""+t).split(e.splitter);break;case"take-from-array":r=t=>{if(t instanceof Array&&t.length){let r=e.index;return r<0&&(r=t.length+r,r<0&&(r=0)),t[r]}return null};break;case"take-html":r=e=>e.innerHTML;break;case"take-image":r=e=>{const t=e.getAttribute("src"),r=e.clientWidth,n=e.clientHeight,i={src:t};return r===n?i.wh=r:(i.w=r,i.h=n),i.wh<40||i.w<40?null:i};break;case"get-offset":r=e=>{const t=e.getBoundingClientRect();return{x:t.left+window.scrollX,y:t.top+window.scrollY}}}let n=t;e.object&&(n=this._ruleToValue(e.object,t));let i=null;return n&&(i=r(n)),i}_toValueAggregate(e,t){const r={};return e.parts.forEach(e=>{r[e.key]=this._ruleToValue(e.value,t)}),r}_toValueTry(e,t){try{return this._ruleToValue(e.what,t)}catch(t){if(e.caseError)return this._ruleToValue(e.caseError)}return null}}}};