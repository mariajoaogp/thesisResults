var _extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var s=arguments[e];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(t[r]=s[r])}return t};function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,s=Array(t.length);e<t.length;e++)s[e]=t[e];return s}return Array.from(t)}const TAB_FOCUS_EVENTS={TAB_ACTIVATED:"tabActivated",TAB_UPDATE:"tabUpdated",WINDOW_CHANGE:"windowFocusChange"};class ContentStateHandler{constructor(t){this.store=t,this.queryRequestBuffer={},this.shouldInject=this.shouldInjectScripts(),webextApi.browserAction.onClicked.addListener(()=>this.toggleSlider()),webextApi.tabs.onActivated.addListener(this.onFocusChanged.bind(this,TAB_FOCUS_EVENTS.TAB_ACTIVATED)),webextApi.windows.onFocusChanged.addListener(this.onFocusChanged.bind(this,TAB_FOCUS_EVENTS.WINDOW_CHANGE)),webextApi.tabs.onUpdated.addListener(this.onFocusChanged.bind(this,TAB_FOCUS_EVENTS.TAB_UPDATE))}shouldInjectScripts(){var t=this.store.getState();const e=t.firstRunDate;return t.version.isFirstTimeUser&&Date.now()-e<2*ONE_HOUR}handleNextPopupState(t){setTimeout(()=>{this.doHandleNextPopupState(t)},200)}async doHandleNextPopupState(t){var e=await getCurrentTab();const s=e.url,r=e.id;if(!this.isValidPageForContent(s))return this.setSystemPopUpState(r);const o=this.store.getState(),i=o.settings.protection,n=i&&!o.user.isPremiumUser;if(!t&&n&&this.shouldShowSpecialOffer(o))return this.setUpgradePopupState(r);this.setNormalPopupState(r,t,i)}shouldShowSpecialOffer(t){const e=t.remoteConfig.features.specialOffer,s=t.firstRunDate;var r=t.settings.upgradePopUp;const o=r.numberOfShow;if(r.show||!e||!e.enable||!e.options||1!==e.options.length)return!1;const i=e.options[0].promptCycleDays;if(o>=i.length)return!1;return Date.now()-s>i[o]*ONE_DAY}setUpgradePopupState(t){webextApi.browserAction.setBadgeText({text:"1"}),webextApi.browserAction.setPopup({tabId:t,popup:"offering.html"}),this.toggleSlider=_.throttle(this.toggleSlider.bind(this),800)}setNormalPopupState(t,e,s){const r=s?"":"popup.html";if(webextApi.browserAction.setPopup({tabId:t,popup:r}),e){const t=this.store.getState().settings.upgradePopUp.show;if(webextApi.browserAction.setBadgeText({text:""}),t)return this.store.dispatch(upgradePopUpData({show:!1})),void 0;this.store.dispatch(OptOutPopUp("default"))}}setSystemPopUpState(t){webextApi.browserAction.setPopup({tabId:t,popup:"systempage.html"})}setErrorState(t){webextApi.browserAction.setPopup({tabId:t,popup:"error.html"})}toggleSlider(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";webextApi.tabs.query({active:!0,currentWindow:!0},e=>{if(!e)return;const s=e[0];if(!s)return;const r={action:TOGGLE_WOT_SLIDER,section:t};webextApi.tabs.sendMessage(s.id,r,t=>{t!==TOGGLE_WOT_SLIDER})})}async onFocusChanged(t){var e=await getCurrentTab();const s=e.url,r=e.id;if(!r)return;if(!this.isValidPageForContent(s))return this.setSystemPopUpState(r);if(!await this.pingToActiveTab(r)){if(!(this.shouldInject&&t!==TAB_FOCUS_EVENTS.TAB_UPDATE))return this.setErrorState(r);await this.injectContentScripts(r,s)}await this.doHandleNextPopupState()}async pingToActiveTab(t){return await new Promise(t=>setTimeout(t,500)),new Promise(e=>{try{webextApi.tabs.sendMessage(t,{action:PING},async t=>{t===PONG&&e(!0),e(!1)})}catch(t){e(!1)}})}isValidPageForContent(t){if(!t||!t.startsWith("http"))return!1;return!["https://chrome.google.com/webstore/","https://microsoftedge.microsoft.com/addons","https://addons.mozilla.org","https://addons.opera.com"].some(e=>t.startsWith(e))&&!/^https?:\/\/localhost/.test(t)}async injectContentScripts(t,e){const s=new Promise(e=>{webextApi.tabs.sendMessage(t,{action:PING},async t=>{if(t===PONG)return e(!0);e(!1)})});if(await s)return Promise.resolve();const r=webextApi.runtime.getManifest(),o=[];for(const t of r.content_scripts)if(this.normalizeRegexp(t.matches).test(e)){for(const e of t.js||[]){if(!e)return;o.push(webextApi.tabs.executeScript({file:e,allFrames:t.all_frames,runAt:t.run_at}))}for(const e of t.css||[]){if(!e)return;o.push(webextApi.tabs.insertCSS({file:e,allFrames:t.all_frames,runAt:t.run_at}))}}return Promise.all(o)}retryQueryData(){webextApi.tabs.query({active:!0,currentWindow:!0},t=>{if(!t)return;const e=t[0];if(!e)return;const s=e.url,r=(new PiFilter).filterAll(s),o={subtrgt:r,sublast:r,subref:"",nt:"retry",atm:["exthead"],epochtime:Date.now(),ch:6,sg:"аc8bb819d",vmt:6,dm:21,vv:1,wp0:1,delta:"AАEAАAAАAАQTCwJQEАAАAАAАAАAАAАAАAАAАAАAАAАA="};this.fetchRating(o)})}extractLinks(t){const e=t.lk;if(!e)return[];try{return Array.from(new Set(JSON.parse(e)[1].data.org.map(t=>getCleanDomain(t.url))))}catch(t){return[]}}fetchRating(t,e){if(!t.subtrgt)return;Object.keys(t).forEach(e=>{const s=t[e];"string"==typeof s&&s.includes("%")&&(t[e]=decodeURIComponent(s))});const s=[getEncodedDomain(t.subtrgt)].concat(_toConsumableArray(this.extractLinks(t))),r=s[0],o=_extends({},t,{target:r,links:s});this.store.dispatch(getRating(o,e))}normalizeRegexp(t){return new RegExp(t.join("|").replace(/\./g,"\\.").replace(/\*/g,".*"))}}